---
import BaseLayout from "../layouts/BaseLayout.astro";
export const prerender = false;
---

<BaseLayout title="Account">
  <section class="max-w-2xl mx-auto px-6 pt-36 pb-48 space-y-20 bg-neutral-900">

  <!-- IDENTITY -->
  <div class="space-y-6">

    <!-- Avatar -->
    <div
      id="avatar-wrapper"
      class="relative w-28 h-28 flex items-center justify-center rounded-full border border-neutral-600 cursor-pointer hover:border-neutral-400 transition"
    >
      <img
        id="avatar"
        class="hidden w-full h-full object-cover rounded-full"
        alt="Profile image"
      />

      <span
        id="avatar-placeholder"
        class="text-xs text-neutral-400 tracking-wide"
      >
        Add photo
      </span>

      <input
        id="avatar-input"
        type="file"
        accept="image/*"
        class="hidden"
      />
    </div>

    <!-- Email + Write -->
    <div class="flex items-center justify-between w-full max-w-xs">

      <p
        id="email"
        class="whitespace-pre-line text-sm leading-relaxed text-neutral-100 max-w-prose">
      </p>

      <a
        href="/posts/new"
        class="text-xs uppercase tracking-widest text-neutral-300 hover:text-neutral-100 transition"
      >
        Write
      </a>

    </div>

  </div>

  <!-- DIVIDER -->
  <hr class="border-neutral-700 my-16" />

  <!-- WRITINGS -->
  <section>

    <h2 class="text-2xl font-light tracking-tight mb-14 text-neutral-100">
      Latest writings
    </h2>

    <ul
      id="writings"
      class="divide-y divide-neutral-700"
    >
      <!-- injected by script -->
    </ul>

  </section>

</section>

</BaseLayout>

<script
  type="module"
  define:vars={{
    SUPABASE_URL: import.meta.env.PUBLIC_SUPABASE_URL,
    SUPABASE_KEY: import.meta.env.PUBLIC_SUPABASE_ANON_KEY
  }}
>
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  const emailEl = document.getElementById("email");
  const writingsEl = document.getElementById("writings");

  const {
    data: { session },
  } = await supabase.auth.getSession();

if (!session) {
  window.location.href = "/login";
} else {
  emailEl.textContent = session.user.email;

  // Fetch writings
  const { data, error } = await supabase
    .from("writings")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    writingsEl.innerHTML =
      "<li class='text-neutral-500'>Failed to load writings.</li>";
  } else if (data.length === 0) {
    writingsEl.innerHTML =
      "<li class='text-neutral-500'>No writings yet.</li>";
  } else {
    
      writingsEl.innerHTML = data
  .map(
    (w) => `
    <li class="py-8">

      <p class="whitespace-pre-line text-sm leading-relaxed text-neutral-100 max-w-prose">
        ${w.content}
      </p>

      <div class="mt-3 flex items-center justify-between max-w-prose">
        <p class="text-xs text-neutral-400">
          ${new Date(w.created_at).toLocaleDateString()}
        </p>

        <button
          data-id="${w.id}"
          class="delete-btn text-xs uppercase tracking-widest text-neutral-400 hover:text-red-500 transition"
        >
          Delete
        </button>
      </div>

    </li>
  `
  )
  .join("");



    // DELETE HANDLERS (STEP 3 â€” EXACT PLACE)
    document.querySelectorAll(".delete-btn").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const id = btn.dataset.id;

        const confirmed = confirm("Delete this writing?");
        if (!confirmed) return;

        const { error } = await supabase
          .from("writings")
          .delete()
          .eq("id", id);

        if (error) {
          alert("Failed to delete");
        } else {
          location.reload();
        }
      });
    });
  }
}

  

  //avatar
  const avatarWrapper = document.getElementById("avatar-wrapper");
const avatarInput = document.getElementById("avatar-input");
const avatarImg = document.getElementById("avatar");
const avatarPlaceholder = document.getElementById("avatar-placeholder");

// open file picker on click
avatarWrapper.addEventListener("click", () => {
  avatarInput.click();
});

// show preview
avatarInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;

  avatarImg.src = URL.createObjectURL(file);
  avatarImg.classList.remove("hidden");
  avatarPlaceholder.classList.add("hidden");
});


</script>

