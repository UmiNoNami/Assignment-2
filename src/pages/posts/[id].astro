---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { supabaseServer } from "../../lib/supabaseServer";

const supabase = supabaseServer({
  request: Astro.request,
  cookies: Astro.cookies,
});

const { id } = Astro.params;

// session (to show comment form)
const { data: { session } } = await supabase.auth.getSession();
const user = session?.user;

const { data: post } = await supabase
  .from("posts")
  .select("id, title, content, created_at, user_id")
  .eq("id", id)
  .single();

if (!post) throw new Error("Post not found");

// fetch comments
const { data: comments } = await supabase
  .from("comments")
  .select("id, content, created_at, user_id")
  .eq("post_id", id)
  .order("created_at", { ascending: false });
---

<BaseLayout title={post.title}>
  <article class="max-w-2xl mx-auto px-6 pt-32 pb-20">
    <h1 class="text-4xl md:text-5xl font-light leading-snug text-neutral-100">
      {post.title}
    </h1>
    <p class="mt-4 text-sm text-neutral-400">
      {new Date(post.created_at).toLocaleDateString()}
    </p>

    <div
      class="mt-14 space-y-6 text-lg leading-relaxed text-neutral-200 whitespace-pre-line
             first-letter:text-5xl first-letter:font-light first-letter:float-left first-letter:mr-3"
    >
      {post.content}
    </div>

    <div class="border-t border-white/10 my-16"></div>

    <!-- COMMENTS -->
    <section class="space-y-8">
      <div class="flex items-baseline justify-between">
        <h2 class="text-xl font-light text-neutral-200">Reflections</h2>
        <p class="text-sm text-neutral-500">{comments?.length ?? 0}</p>
      </div>

      <!-- Add Comment -->
      {user ? (
        <form method="POST" action="/api/comments" class="space-y-3">
          <input type="hidden" name="post_id" value={post.id} />
          <textarea
            name="content"
            rows="4"
            required
            placeholder="Leave a quiet thought…"
            class="w-full rounded-xl bg-neutral-900/60 border border-white/10 p-4 text-neutral-100 placeholder:text-neutral-500 focus:outline-none focus:ring-2 focus:ring-white/20"
          ></textarea>
          <button
            class="rounded-xl border border-white/10 bg-white/5 px-4 py-2 text-sm text-neutral-100 hover:bg-white/10 transition"
            type="submit"
          >
            Comment
          </button>
        </form>
      ) : (
        <p class="text-sm text-neutral-400">
          <a href="/login" class="underline hover:text-white">Enter</a> to comment.
        </p>
      )}

      <!-- Comments list -->
      <div class="space-y-5">
        {comments?.map((c) => (
          <div class="rounded-2xl border border-white/10 bg-neutral-900/40 p-5">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <!-- simple “avatar” circle (no profile images needed) -->
                <div class="h-9 w-9 rounded-full bg-white/10 flex items-center justify-center text-xs text-neutral-200">
                  {c.user_id.slice(0, 2).toUpperCase()}
                </div>
                <p class="text-sm text-neutral-300">Anonymous</p>
              </div>
              <p class="text-xs text-neutral-500">
                {new Date(c.created_at).toLocaleDateString()}
              </p>
            </div>

            <p class="mt-3 text-neutral-200 leading-relaxed whitespace-pre-line">
              {c.content}
            </p>
          </div>
        ))}
      </div>
    </section>
  </article>
</BaseLayout>
